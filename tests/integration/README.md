# Мок-тесты для handlers

Этот каталог содержит мок-тесты для HTTP handlers проекта. Тесты используют моки сервисов вместо реальной базы данных.

## Особенности

- ✅ Тесты не требуют подключения к базе данных
- ✅ Быстрое выполнение (нет операций с БД)
- ✅ Изолированное тестирование handlers
- ✅ Полный контроль над поведением сервисов через моки

## Структура

- `helper.go` - вспомогательные функции для тестирования (setupTestHandler, makeRequest)
- `mocks.go` - моки для сервисов (User, Team, PullRequest)
- `team_test.go` - тесты для эндпоинтов команд
- `user_test.go` - тесты для эндпоинтов пользователей
- `pull_request_test.go` - тесты для эндпоинтов pull requests
- `validation_test.go` - тесты валидации входных данных

## Запуск тестов

Из корневой директории проекта:

```bash
go test ./tests/integration/... -v
```

Или для запуска конкретного теста:

```bash
go test ./tests/integration/... -v -run TestAddTeam
```

## Что тестируется

Тесты покрывают все основные эндпоинты API с использованием моков:

### Команды (Teams)
- ✅ Создание команды (`POST /team/add`)
- ✅ Получение команды (`GET /team/get`)
- ✅ Получение PR команды (`GET /team/pullRequests`)
- ✅ Деактивация пользователей команды (`POST /team/deactivateUsers`)
- ✅ Обработка дублирующихся команд
- ✅ Обработка несуществующих команд

### Пользователи (Users)
- ✅ Установка активности пользователя (`POST /users/setIsActive`)
- ✅ Получение PR для ревью (`GET /users/getReview`)
- ✅ Получение статистики назначений (`GET /users/userAssignments`)
- ✅ Обработка несуществующих пользователей

### Pull Requests
- ✅ Создание PR (`POST /pullRequest/create`)
- ✅ Слияние PR (`POST /pullRequest/merge`)
- ✅ Переназначение ревьювера (`POST /pullRequest/reassign`)
- ✅ Обработка дублирующихся PR
- ✅ Обработка попыток изменения слитых PR
- ✅ Обработка различных ошибок (NOT_ASSIGNED, NO_CANDIDATE)

### Валидация
- ✅ Валидация входных данных
- ✅ Обработка некорректных запросов

## Как работают моки

Моки реализуют интерфейсы сервисов и позволяют настроить поведение для каждого теста:

```go
mockSvc := NewMockService()
mockSvc.Team.(*MockTeamService).AddTeamFunc = func(ctx context.Context, team *models.Team) (*models.Team, error) {
    // Возвращаем ожидаемый результат
    return expectedTeam, nil
}
```

Это позволяет тестировать handlers изолированно, проверяя:
- Правильность обработки успешных ответов
- Корректность обработки ошибок
- Валидацию входных данных
- Формат ответов

## Преимущества мок-тестов

1. **Скорость** - тесты выполняются мгновенно, без операций с БД
2. **Изоляция** - каждый тест полностью независим
3. **Контроль** - можно легко симулировать любые сценарии и ошибки
4. **Простота** - не требуется настройка тестовой БД
5. **Надежность** - нет зависимости от состояния БД

## Отличие от E2E тестов

Эти тесты проверяют только слой handlers и их взаимодействие с сервисами. Они **не** проверяют:
- Реальную работу с базой данных
- Интеграцию между слоями (repository, service)
- Корректность SQL запросов

Для полного E2E тестирования потребуются отдельные интеграционные тесты с реальной БД.
