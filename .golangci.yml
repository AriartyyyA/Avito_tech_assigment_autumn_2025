# Конфигурация golangci-lint для проекта Avito Tech Assignment
# 
# golangci-lint - это агрегатор линтеров для Go, который объединяет множество
# статических анализаторов кода в одном инструменте.

# Версия конфигурации
version: 2

# Настройки запуска линтера
run:
  # Таймаут для выполнения линтера (по умолчанию 1 минута)
  timeout: 5m
  
  # Включить проверку тестовых файлов
  tests: true
  
  # Включить проверку автогенерированных файлов
  skip-autogenerated: false
  
  # Исключить директории из проверки
  skip-dirs:
    - vendor
    - migrations  # SQL миграции не нужно проверять линтером
  
  # Исключить файлы из проверки
  skip-files:
    - ".*\\.pb\\.go$"  # Исключить protobuf сгенерированные файлы
    - ".*_mock\\.go$"  # Исключить mock файлы (если используются)

# Настройки вывода
output:
  # Формат вывода: colored-line-number, line-number, json, tab, checkstyle, code-climate, junit, github-actions
  formats:
    - format: colored-line-number
      path: stdout
  
  # Показывать только новые проблемы (для CI/CD)
  print-issued-lines: true
  print-linter-name: true
  uniq-by-line: true
  sort-results: true

# Настройки линтеров
linters:
  # Отключить все линтеры по умолчанию
  disable-all: true
  
  # Включить только нужные линтеры
  enable:
    # Базовые линтеры Go
    - errcheck          # Проверка обработки ошибок
    - gosimple          # Упрощение кода
    - govet             # Статический анализ (go vet)
    - ineffassign       # Обнаружение неиспользуемых присваиваний
    - staticcheck       # Статический анализ кода
    - unused            # Обнаружение неиспользуемого кода
    
    # Стиль кода
    - gofmt             # Проверка форматирования (gofmt)
    - goimports         # Проверка импортов
    - gci               # Упорядочивание импортов
    - misspell          # Проверка орфографии в комментариях
    - revive            # Замена golint (проверка стиля кода)
    
    # Сложность и качество кода
    - gocyclo           # Проверка цикломатической сложности
    - gocognit          # Проверка когнитивной сложности
    - goconst           # Обнаружение магических строк и чисел
    - gocritic          # Критический анализ кода
    - goerr113          # Проверка ошибок (лучшие практики)
    
    # Безопасность
    - gosec             # Анализ безопасности кода
    
    # Производительность
    - prealloc          # Предварительное выделение слайсов
    - bodyclose         # Проверка закрытия HTTP body
    
    # Документация
    - godot             # Проверка точек в комментариях
    - godox             # Проверка TODO/FIXME комментариев
    
    # Другие полезные проверки
    - exportloopref     # Обнаружение ссылок на переменные цикла
    - noctx             # Проверка передачи context в функции
    - nolintlint        # Проверка корректности директив nolint

# Настройки конкретных линтеров
linters-settings:
  # Настройки revive (замена golint)
  revive:
    # Правила для revive
    rules:
      - name: exported
        severity: warning
        disabled: false
      - name: var-naming
        severity: warning
        disabled: false
      - name: package-comments
        severity: warning
        disabled: false
      - name: range
        severity: warning
        disabled: false
      - name: increment-decrement
        severity: warning
        disabled: false
      - name: error-return
        severity: warning
        disabled: false
      - name: error-naming
        severity: warning
        disabled: false
      - name: error-strings
        severity: warning
        disabled: false
      - name: receiver-naming
        severity: warning
        disabled: false
      - name: unexported-return
        severity: warning
        disabled: false
      - name: time-equal
        severity: warning
        disabled: false
      - name: banned-characters
        severity: warning
        disabled: false
      - name: context-keys-type
        severity: warning
        disabled: false
      - name: if-return
        severity: warning
        disabled: false
      - name: increment-decrement
        severity: warning
        disabled: false
      - name: var-declaration
        severity: warning
        disabled: false
      - name: range-val-in-closure
        severity: warning
        disabled: false
      - name: range-val-address
        severity: warning
        disabled: false
      - name: waitgroup-by-value
        severity: warning
        disabled: false
      - name: atomic
        severity: warning
        disabled: false
      - name: empty-lines
        severity: warning
        disabled: false
      - name: line-length-limit
        severity: warning
        disabled: false
        arguments:
          - 120  # Максимальная длина строки

  # Настройки gocyclo (цикломатическая сложность)
  gocyclo:
    min-complexity: 15  # Минимальная сложность для предупреждения

  # Настройки gocognit (когнитивная сложность)
  gocognit:
    min-complexity: 15  # Минимальная когнитивная сложность

  # Настройки gocritic
  gocritic:
    enabled-tags:
      - diagnostic
      - experimental
      - opinionated
      - performance
      - style
    disabled-checks:
      - dupImport  # Разрешить дублирующиеся импорты (иногда нужно)
      - ifElseChain # Разрешить цепочки if-else
    enabled-checks:
      - appendAssign
      - argOrder
      - badCall
      - badCond
      - badLock
      - badRegexp
      - builtinShadow
      - caseOrder
      - commentFormatting
      - commentedOutCode
      - deferInLoop
      - docStub
      - dupArg
      - dupBranchBody
      - dupCase
      - dupSubExpr
      - emptyFallthrough
      - evalOrder
      - exitAfterDefer
      - flagName
      - hexLiteral
      - ifElseChain
      - importShadow
      - indexAlloc
      - initClause
      - methodExprCall
      - nilValReturn
      - octalLiteral
      - offBy1
      - paramTypeCombine
      - rangeExprCopy
      - rangeValCopy
      - regexpMust
      - regexpPattern
      - ruleguard
      - singleCaseSwitch
      - sloppyLen
      - sloppyReassign
      - stringXbytes
      - switchTrue
      - timeExpr
      - todoCommentWithoutDetail
      - truncateCmp
      - typeAssertChain
      - typeDefFirst
      - typeSwitchVar
      - unlabelStmt
      - unlambda
      - unnecessaryDefer
      - unnecessaryBlock
      - valSwap
      - weakCond
      - whyNoLint
      - wrapperFunc
      - yodaStyleExpr

  # Настройки gosec (безопасность)
  gosec:
    # Уровень конфиденциальности: 0 = низкий, 1 = средний, 2 = высокий
    severity: medium
    # Уровень уверенности: 0 = низкий, 1 = средний, 2 = высокий
    confidence: medium
    # Исключить проверки
    excludes:
      - G104  # Игнорировать ошибки без обработки (иногда допустимо)
      - G107  # Игнорировать проверку URL в HTTP запросах (если URL валидируется отдельно)

  # Настройки goconst (магические строки и числа)
  goconst:
    min-len: 3        # Минимальная длина строки для проверки
    min-occurrences: 2  # Минимальное количество повторений

  # Настройки goimports
  goimports:
    local-prefixes: github.com/AriartyyyA/Avito_tech_assigment_autumn_2025

  # Настройки gci (упорядочивание импортов)
  gci:
    # Порядок импортов: stdlib, prefix (локальные), default
    sections:
      - standard  # Стандартная библиотека
      - default   # Внешние зависимости
      - prefix(github.com/AriartyyyA/Avito_tech_assigment_autumn_2025)  # Локальные импорты
    # Разделитель между группами импортов
    skip-generated: true
    skip-vendor: true

  # Настройки godot (точки в комментариях)
  godot:
    # Проверять все комментарии, не только экспортированные
    scope: all
    # Требовать точку в конце комментария
    exclude:
      - "^TODO:"
      - "^FIXME:"
      - "^XXX:"

  # Настройки misspell (орфография)
  misspell:
    locale: US  # Локаль для проверки орфографии

  # Настройки errcheck
  errcheck:
    # Проверять ошибки в функциях с именем, начинающимся с Check
    check-type-assertions: true
    # Проверять ошибки в присваиваниях
    check-blank: true
    # Игнорировать функции
    ignore: fmt:.*,io/ioutil:^Read.*

  # Настройки staticcheck
  staticcheck:
    checks: ["all", "-SA1019"]  # Все проверки кроме устаревших

  # Настройки noctx (проверка context)
  noctx:
    # Разрешенные функции, которые могут не принимать context
    allowed: ["fmt\\.Print.*", "log\\.Print.*"]

  # Настройки bodyclose (проверка закрытия HTTP body)
  bodyclose:
    # Проверять все HTTP методы
    check-exported: true

# Исключения (issues, которые нужно игнорировать)
issues:
  # Максимальное количество проблем одного типа
  max-issues-per-linter: 0  # 0 = без ограничений
  max-same-issues: 0  # 0 = без ограничений
  
  # Исключить проблемы в новых строках (для CI/CD)
  new: false
  
  # Исключить автогенерированные файлы
  exclude-rules:
    # Исключить проверки для тестовых файлов (некоторые правила)
    - path: _test\.go
      linters:
        - errcheck  # В тестах можно игнорировать некоторые ошибки
        - gosec     # В тестах можно использовать менее строгие проверки безопасности
    
    # Исключить проверки для миграций
    - path: migrations/
      linters:
        - all
    
    # Исключить проверки для mock файлов
    - path: _mock\.go
      linters:
        - all
    
    # Исключить проверки для protobuf файлов
    - path: \.pb\.go$
      linters:
        - all

  # Исключить конкретные проблемы по тексту
  exclude:
    # Игнорировать предупреждения о неиспользуемых переменных в тестах
    - "Error return value of .((os\\.)?std(out|err)\\..*|.*Close|.*Flush|.*Write|.*Print.*|.*Read.*) is not checked"
    - "exported function .* should have comment or be unexported"
    - "package comment should be of the form"

  # Не показывать проблемы в старых файлах (для постепенного внедрения)
  exclude-use-default: false

# Настройки сервера (для использования в CI/CD)
severity:
  # Изменить уровень серьезности для конкретных правил
  default-severity: error
  case-sensitive: false
  rules:
    - linters:
        - revive
      severity: warning
    - linters:
        - misspell
      severity: warning
    - linters:
        - godot
      severity: warning

